# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1zO4Ekt-jQBcMnPCp54a96hls5idHOV4w
"""

import streamlit as st
import pandas as pd
import numpy as np
import pickle
import os
import time
import random
from datetime import datetime

# ğŸ¨ Page config
st.set_page_config(page_title="ğŸ“š Book Genre Preference Survey", page_icon="ğŸ“–")

st.title("ğŸ“š Book Genre Preference Survey")
st.markdown("Predict your **preferred book genre** using machine learning!")

# ğŸ§  Load model, scaler, encoders
with open("model.pkl", "rb") as f:
    model = pickle.load(f)
with open("scaler.pkl", "rb") as f:
    scaler = pickle.load(f)
with open("encoders.pkl", "rb") as f:
    encoders = pickle.load(f)

st.success("âœ… Model and preprocessors loaded!")

# ğŸ­ Emoji map for genres
emoji_map = {
    "Fantasy": "ğŸ§™â€â™‚ï¸",
    "Romance": "ğŸ’–",
    "Mystery": "ğŸ•µï¸â€â™€ï¸",
    "Science Fiction": "ğŸš€",
    "Nonfiction": "ğŸ“˜",
    "Horror": "ğŸ‘»",
    "Comedy": "ğŸ˜‚"
}

# âœï¸ User Input
st.header("âœï¸ Enter Your Preferences")

input_data = {}
categorical_fields = list(encoders.keys())
numerical_fields = ["Age", "Books_Read_Per_Year"]  # â† Replace with your real fields

for field in categorical_fields:
    options = list(encoders[field].classes_)
    input_data[field] = st.selectbox(field, options)

for field in numerical_fields:
    input_data[field] = st.number_input(field, min_value=0.0)

submit = st.button("ğŸ¯ Predict My Book Genre")

# ğŸ” Prediction logic
if submit:
    st.header("ğŸ” Prediction Result")

    # Encode and scale input
    encoded_input = []
    for field in categorical_fields:
        encoded_val = encoders[field].transform([input_data[field]])[0]
        encoded_input.append(encoded_val)
    for field in numerical_fields:
        encoded_input.append(input_data[field])

    X_input = np.array([encoded_input])
    X_scaled = scaler.transform(X_input)

    # ğŸ¬ Spinner effect
    with st.spinner("ğŸ” Analyzing your preferences..."):
        time.sleep(2)
        pred = model.predict(X_scaled)[0]

    genre_emoji = emoji_map.get(pred, "ğŸ“š")
    st.success(f"{genre_emoji} Your Preferred Book Genre is: **{pred}** {genre_emoji}")

    # ğŸˆ Fun effects
    st.balloons()
    st.snow()

    # ğŸ’¬ Quote of the day
    quotes = [
        "â€œA reader lives a thousand lives before he dies.â€ â€“ George R.R. Martin",
        "â€œSo many books, so little time.â€ â€“ Frank Zappa",
        "â€œUntil I feared I would lose it, I never loved to read.â€ â€“ Harper Lee",
        "â€œBooks are a uniquely portable magic.â€ â€“ Stephen King"
    ]
    st.info(f"ğŸ“– **Quote of the Day:** {random.choice(quotes)}")

    # ğŸŒ€ Try again button
    if st.button("ğŸ”„ Try Again"):
        st.experimental_rerun()

    # ğŸ˜„ Emoji feedback
    st.header("ğŸ˜„ How do you feel about your result?")
    feedback = st.radio(
        "React with an emoji!",
        ["ğŸ˜ Loved it!", "ğŸ™‚ It's okay", "ğŸ˜ Meh", "ğŸ˜• Not accurate", "ğŸ˜¡ Hate it!"]
    )

    if feedback:
        st.success(f"Thanks for your feedback! {feedback}")

        # ğŸ—‚ï¸ Save Feedback to CSV
        log_data = {
            "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            "predicted_genre": pred,
            "feedback": feedback
        }
        log_data.update(input_data)
        log_df = pd.DataFrame([log_data])

        log_file = "feedback_log.csv"
        if os.path.exists(log_file):
            log_df.to_csv(log_file, mode='a', header=False, index=False)
        else:
            log_df.to_csv(log_file, index=False)

        st.info("ğŸ“ Your feedback has been saved!")
